<!--
BSD 2-Clause License

Copyright (c) 2017, The HeadphoneCheck Authors (see AUTHORS)
All rights reserved.

Contact Ray Gonzalez raygon@mit.edu or Kevin J. P. Woods kwoods@mit.edu
=======================================================================
-->

<!DOCTYPE html>
<html>
  <head>
    <!-- Import jQuery from Google CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="/templates/HeadphoneCheck.js"></script> 
    <style type="text/css">
      *, *::before, *::after {
        box-sizing: border-box;
        font-family: Monaco;
      }

      div{
        margin-bottom: 15px;
      }

      body {
        margin-top: 0;
        padding-left: 20vh;
        padding-right: 20vh;
        display: flex;
        flex-direction: column;
      }

      li {
        margin-bottom: 20px;
        font-size: 17px;
      }

      input[type=radio] {
        height:17px; 
        width:17px;
      }

      label{
        display: block;
      }

      #message {
        font-weight: bold;
        text-align: center;
        cursor: pointer;
        font-size: 15px;
        width: 170px;
        height: 40px;
        background-color: #efefef;
        border: 2px solid black;
      }

      #message:hover,
      #message:focus{
        background-color:#c7c7c7;
      }

      #modal {
	      position: absolute;
	      left: 0;
	      top: 0;
	      width: 100%;
	      height: 100%;
	      background-color: rgba(0,0,0,0.4);
      }

      .instructions {
	      margin: auto;
	      padding: 40px;
	      width: 80%;
	      height: 100vh;
	      background-color: white;
      }

      #sign {
	      font-size: 30px;
	      font-weight: bold;
	      color: rgba(0,0,0,0.4);
      }

      .move {
        display: inline;
        margin-right: 10px;
        padding-left: 20px;
        padding-right: 20px;
        padding-bottom: 5px;
        font-size: 25px;
        cursor: pointer;
      }

      #instruction-move {
        position: absolute;
        right: 13%;
        bottom: 15px;
      }

      #sign:hover,
      #sign:focus {
	      cursor: pointer;
	      color: rgba(0,0,0,0.7);
      }
    </style>
  </head>

  <body onload="HeadphoneCheck.runHeadphoneCheck();">
    <div style="margin-top: 6vh;"> <button id="message">Instructions</button></div>
			<div id="modal">
				<div class="instructions">
					<span id="sign" style="float: right;">&times;</span>
					<ul id="instruction1">
						<p style="font-size: 17px;">Page 1 / 6</p>
            <h3 style="text-align: center; color: blue;"> Welcome to the Annotation Interface!<br> You may exit the instructions by pressing 'x' on the top right corner </h3>
						<img src="/templates/interface/img/1.png" style="width:75%; margin-bottom: 10px;">
						<li> Click 'Play Audio' to play the audio </li>
						<li> Click 'Pause Audio' to pause the current audio </li>
						<li> You may re-play the audio as many times as needed </li>
					</ul>
					<ul id="instruction2" style="display: none;">
						<p style="font-size: 17px;">Page 2 / 6</p>
						<img src="/templates/interface/img/2.png" style="width:75%; margin-bottom: 10px;">
						<li> Once you have finished listening to the audio, you may see a dropdown menu in which you may select the number of sources you have heard </li>
						<li> You may annotate <b>LESS</b> number of annotation points if you want, but you must annotate <b>AT LEAST</b> 1 source </li>
					</ul>
					<ul id="instruction3" style="display: none;">
						<p style="font-size: 17px;">Page 3 / 6</p>
						<img src="/templates/interface/img/3.png" style="width:75%; margin-bottom: 10px;">
						<li> Once you have selected a numberï¼Œthree 2D views will automatically appear </li>
						<li> These three views are where you perform the annotation </li>
						<li> The head view is for azimuth annotation, and the back and side views are for elevation annotation </li>
					</ul>
					<ul id="instruction4" style="display: none;">
						<p style="font-size: 17px;">Page 4 / 6</p>
						<img src="/templates/interface/img/4.png" style="width:75%; margin-bottom: 10px;">
						<li> <b> You may always check the keyboard rules by pressing the [Keyboard Rules] button  </b> </li>
						<li> Press <b>[Option]</b> or <b>[Alt]</b> key to add an annotation once you see the cursor turning to '+' </li>
						<li> Press <b>[Command]</b> or <b>[Win]</b> key to delete an annotation once you see the cursor turning to '-' </li>
						<li> Deleting an annotation means to delete both its annotated azimuth and elevation </li>
					</ul>
					<ul id="instruction5" style="display: none;">
						<p style="font-size: 17px;">Page 5 / 6</p>
						<img src="/templates/interface/img/5.png" style="width:75%; margin-bottom: 10px;">
						<li> You may adjust the azimuth and the elevation with [+] and [-] buttons, or by dragging the annotation dots </li>
						<li> At certain angles where the annotation can be "seen" from both the back and the side view, the system will annotate the 'second elevation' for you</li>
						<li> The annotation will appear automatically in the 3D view </li>
            <li> Under certain degrees, the bottom point will be enlarged for your convinience </li>
					</ul>
					<ul id="instruction6" style="display: none;">
						<p style="font-size: 17px;">Page 6 / 6</p>
						<img src="/templates/interface/img/4.png" style="width:75%; margin-bottom: 10px;">
						<li> You may rotate the 3D head, but you can not perform anything towards the head directly </li>
						<li> You can not annotate more annotations than the number of sources you have entered </li>
						<li> You may change the number of sources you have entered </li>
					</ul>
					<div id="instruction-move">
						<button class="move" id="instruction-left">&lt;</button>
						<button class="move" id="instruction-right">&gt;</button>
					</div>
				</div>
			</div>

    <div id="hc-container"></div>
    <script>
      $(document).on('hcHeadphoneCheckEnd', function(event, data) {
        var results = data.data;
        var config = data.config;
        var didPass = data.didPass;
        if (didPass) ajax_start();
        else {
          $('<div/>', {
            html: 'Screening task failed.<br/><br/>Total Correct: ' + results.totalCorrect + '<br/>Please re-do the head phone check tasks'
          }).appendTo($('body'));
        }
      });

      var curr_instruction = 1;
  
      document.getElementById('message').addEventListener("click",popRules);
      document.getElementById('instruction-left').addEventListener("click",move_instruction_last);
      document.getElementById('instruction-right').addEventListener("click",move_instruction_next);
      document.getElementById("sign").addEventListener("click",closeRules);
  
      function popRules(e){ 
        e.preventDefault();
        modal.style.display = "block";
      }
  
      function closeRules(e){ 
        e.preventDefault();
        modal.style.display = "none";
      }
  
      function move_instruction_next(e){
        e.preventDefault();
        if (curr_instruction < 6) {
          document.getElementById('instruction'+curr_instruction).style.display = 'none';
          document.getElementById('instruction'+(curr_instruction+1)).style.display = '';
          curr_instruction += 1;
        }
      }
  
      function move_instruction_last(e){
        e.preventDefault();
        if (curr_instruction > 1) {
          document.getElementById('instruction'+curr_instruction).style.display = 'none';
          document.getElementById('instruction'+(curr_instruction-1)).style.display = '';
          curr_instruction -= 1;
        }
      }

      function ajax_start(){
        var req = new XMLHttpRequest();
        req.open('POST', '/annotation_interface');
        req.onreadystatechange = function() {
          if (req.readyState == 4 && req.response != 'success') window.alert('Something went wrong');
          if ((req.status == 200 || req.status == 304) && req.responseText == 'success') window.location = '/templates/interface/test.html';
        }
        req.send();
      }
    </script>
  </body>
</html>
